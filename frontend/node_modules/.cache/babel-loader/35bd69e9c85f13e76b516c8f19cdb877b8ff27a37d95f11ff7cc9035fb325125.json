{"ast":null,"code":"//@ts-nocheck\nimport { ActivityBlock } from '../../abstract/ActivityBlock.js';\nimport { UploaderBlock } from '../../abstract/UploaderBlock.js';\nimport { stringToArray } from '../../utils/stringToArray.js';\nimport { canUsePermissionsApi } from '../utils/abilities.js';\nimport { deserializeCsv } from '../utils/comma-separated.js';\nimport { debounce } from '../utils/debounce.js';\nimport { UploadSource } from '../utils/UploadSource.js';\nimport { CameraSourceEvents, CameraSourceTypes } from './constants.js';\nconst DEFAULT_VIDEO_CONFIG = {\n  width: {\n    ideal: 1920\n  },\n  height: {\n    ideal: 1080\n  },\n  frameRate: {\n    ideal: 30\n  }\n};\nconst DEFAULT_PERMISSIONS = ['camera', 'microphone'];\n\n/**\n * @param {Number} time\n * @returns\n */\nfunction formatTime(time) {\n  const minutes = Math.floor(time / 60).toString().padStart(2, '0');\n  const seconds = Math.floor(time % 60).toString().padStart(2, '0');\n  return `${minutes}:${seconds}`;\n}\nconst DEFAULT_PICTURE_FORMAT = 'image/jpeg';\nconst DEFAULT_VIDEO_FORMAT = 'video/webm';\n\n/** @typedef {'photo' | 'video'} CameraMode */\n\n/** @typedef {'shot' | 'retake' | 'accept' | 'play' | 'stop' | 'pause' | 'resume'} CameraStatus */\n\nexport class CameraSource extends UploaderBlock {\n  couldBeCtxOwner = true;\n  activityType = ActivityBlock.activities.CAMERA;\n\n  /** @private */\n  _unsubPermissions = null;\n\n  /** @type {BlobPart[]} */\n  _chunks = [];\n\n  /** @type {MediaRecorder | null} */\n  _mediaRecorder = null;\n\n  /** @type {MediaStream | null} */\n  _stream = null;\n\n  /** @type {string | null} */\n  _selectedAudioId = null;\n\n  /** @type {string | null} */\n  _selectedCameraId = null;\n  constructor() {\n    super();\n    this.init$ = {\n      ...this.init$,\n      video: null,\n      videoTransformCss: null,\n      videoHidden: true,\n      messageHidden: true,\n      requestBtnHidden: canUsePermissionsApi(),\n      cameraSelectOptions: null,\n      cameraSelectHidden: true,\n      l10nMessage: '',\n      // This is refs\n      switcher: null,\n      panels: null,\n      timer: null,\n      timerHidden: true,\n      cameraHidden: true,\n      cameraActionsHidden: true,\n      audioSelectOptions: null,\n      audioSelectHidden: true,\n      audioSelectDisabled: true,\n      audioToggleMicrophoneHidden: true,\n      tabCameraHidden: true,\n      tabVideoHidden: true,\n      currentIcon: 'camera-full',\n      currentTimelineIcon: 'play',\n      toggleMicrophoneIcon: 'microphone',\n      /** @type {Number} */\n      _startTime: 0,\n      /** @type {Number} */\n      _elapsedTime: 0,\n      _animationFrameId: null,\n      mutableClassButton: 'uc-shot-btn uc-camera-action',\n      /** @param {Event} e */\n      onCameraSelectChange: e => {\n        this._selectedCameraId = e.target.value;\n        this._capture();\n      },\n      /** @param {Event} e */\n      onAudioSelectChange: e => {\n        this._selectedAudioId = e.target.value;\n        this._capture();\n      },\n      onCancel: () => {\n        this.historyBack();\n      },\n      onShot: () => this._shot(),\n      onRequestPermissions: () => this._capture(),\n      /** General method for photo and video capture */\n      onStartCamera: () => this._chooseActionWithCamera(),\n      onStartRecording: () => this._startRecording(),\n      onStopRecording: () => this._stopRecording(),\n      onToggleRecording: () => this._toggleRecording(),\n      onToggleAudio: () => this._toggleEnableAudio(),\n      onRetake: () => this._retake(),\n      onAccept: () => this._accept(),\n      /** @param {MouseEvent} e */\n      onClickTab: e => {\n        const id = /** @type {HTMLElement} */e.currentTarget.getAttribute('data-id');\n        if (id) this._handleActiveTab(/** @type {CameraMode} */id);\n      }\n    };\n  }\n  _chooseActionWithCamera = () => {\n    if (this._activeTab === CameraSourceTypes.PHOTO) {\n      this._shot();\n    }\n    if (this._activeTab === CameraSourceTypes.VIDEO) {\n      if (this._mediaRecorder?.state === 'recording') {\n        this._stopRecording();\n        return;\n      }\n      this._startRecording();\n    }\n  };\n  _updateTimer = () => {\n    const currentTime = Math.floor((performance.now() - this.$._startTime + this.$._elapsedTime) / 1000);\n    if (typeof this.cfg.maxVideoRecordingDuration === 'number' && this.cfg.maxVideoRecordingDuration > 0) {\n      const remainingTime = this.cfg.maxVideoRecordingDuration - currentTime;\n      if (remainingTime <= 0) {\n        this.ref.timer.textContent = formatTime(remainingTime);\n        this._stopRecording();\n        return;\n      }\n      this.ref.timer.textContent = formatTime(remainingTime);\n    } else {\n      this.ref.timer.textContent = formatTime(currentTime);\n    }\n    this._animationFrameId = requestAnimationFrame(this._updateTimer);\n  };\n  _startTimer = () => {\n    this.$._startTime = performance.now();\n    this.$._elapsedTime = 0;\n    this._updateTimer();\n  };\n  _stopTimer = () => {\n    if (this._animationFrameId) cancelAnimationFrame(this._animationFrameId);\n  };\n  _startTimeline = () => {\n    const currentTime = this.ref.video.currentTime;\n    const duration = this.ref.video.duration;\n    this.ref.line.style.transform = `scaleX(${currentTime / duration})`;\n    this.ref.timer.textContent = formatTime(currentTime);\n    this._animationFrameId = requestAnimationFrame(this._startTimeline);\n  };\n  _stopTimeline = () => {\n    if (this._animationFrameId) cancelAnimationFrame(this._animationFrameId);\n  };\n  _startRecording = () => {\n    try {\n      this._chunks = [];\n      this._options = {\n        ...this.cfg.mediaRecorderOptions\n      };\n      const {\n        mimeType\n      } = this.cfg.mediaRecorderOptions || {};\n      if (mimeType && MediaRecorder.isTypeSupported(mimeType)) {\n        this._options.mimeType = mimeType;\n      } else if (MediaRecorder.isTypeSupported(DEFAULT_VIDEO_FORMAT)) {\n        this._options.mimeType = DEFAULT_VIDEO_FORMAT;\n      } else {\n        this._options.mimeType = 'video/mp4';\n      }\n      if (this._stream) {\n        this._mediaRecorder = new MediaRecorder(this._stream, this._options);\n        this._mediaRecorder.start();\n        this._mediaRecorder.addEventListener('dataavailable', e => {\n          this._chunks.push(e.data);\n        });\n        this._startTimer();\n        this.classList.add('uc-recording');\n        this._setCameraState(CameraSourceEvents.PLAY);\n      }\n    } catch (error) {\n      console.error('Failed to start recording', error);\n    }\n  };\n\n  /** @private */\n  _stopRecording = () => {\n    this._mediaRecorder?.addEventListener('stop', () => {\n      this._previewVideo();\n      this._stopTimer();\n      this._setCameraState(CameraSourceEvents.STOP);\n    });\n    this._mediaRecorder?.stop();\n    this.classList.remove('uc-recording');\n  };\n\n  /** This method is used to toggle recording pause/resume */\n  _toggleRecording = () => {\n    if (this._mediaRecorder?.state === 'recording') return;\n    if (!this.ref.video.paused && !this.ref.video.ended && this.ref.video.readyState > 2) {\n      this.ref.video.pause();\n    } else if (this.ref.video.paused) {\n      this.ref.video.play();\n    }\n  };\n  _toggleEnableAudio = () => {\n    this._stream?.getAudioTracks().forEach(track => {\n      track.enabled = !track.enabled;\n      this.$.toggleMicrophoneIcon = !track.enabled ? 'microphone-mute' : 'microphone';\n      this.$.audioSelectDisabled = !track.enabled;\n    });\n  };\n\n  /**\n   * Previewing the video that was recorded on the camera\n   *\n   * @private\n   */\n  _previewVideo = () => {\n    try {\n      const blob = new Blob(this._chunks, {\n        type: this._mediaRecorder?.mimeType\n      });\n      const videoURL = URL.createObjectURL(blob);\n      this.ref.video.muted = false;\n      this.ref.video.volume = 1;\n      this.$.video = null;\n      this.ref.video.src = videoURL;\n      this.ref.video.addEventListener('play', () => {\n        this._startTimeline();\n        this.set$({\n          currentTimelineIcon: 'pause'\n        });\n      });\n      this.ref.video.addEventListener('pause', () => {\n        this.set$({\n          currentTimelineIcon: 'play'\n        });\n        this._stopTimeline();\n      });\n    } catch (error) {\n      console.error('Failed to preview video', error);\n    }\n  };\n  _retake = () => {\n    this._setCameraState(CameraSourceEvents.RETAKE);\n\n    /** Reset video */\n    if (this._activeTab === CameraSourceTypes.VIDEO) {\n      this.$.video = this._stream;\n      this.ref.video.muted = true;\n    }\n    this.ref.video.play();\n  };\n  _accept = () => {\n    this._setCameraState(CameraSourceEvents.ACCEPT);\n    if (this._activeTab === CameraSourceTypes.PHOTO) {\n      this._canvas?.toBlob(blob => {\n        const file = this._createFile('camera', 'jpeg', DEFAULT_PICTURE_FORMAT, blob);\n        this._toSend(file);\n      }, DEFAULT_PICTURE_FORMAT);\n      return;\n    }\n    const blob = new Blob(this._chunks, {\n      type: this._mediaRecorder?.mimeType\n    });\n    const ext = this._guessExtensionByMime(this._mediaRecorder?.mimeType);\n    const file = this._createFile('video', ext, `video/${ext}`, blob);\n    this._toSend(file);\n    this._chunks = [];\n  };\n\n  /** @param {CameraStatus} status */\n  _handlePhoto = status => {\n    if (status === CameraSourceEvents.SHOT) {\n      this.set$({\n        tabVideoHidden: true,\n        cameraHidden: true,\n        tabCameraHidden: true,\n        cameraActionsHidden: false,\n        cameraSelectHidden: true\n      });\n    }\n    if (status === CameraSourceEvents.RETAKE || status === CameraSourceEvents.ACCEPT) {\n      this.set$({\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        cameraHidden: false,\n        cameraActionsHidden: true,\n        cameraSelectHidden: this._cameraDevices.length <= 1\n      });\n    }\n  };\n\n  /** @param {CameraStatus} status */\n  _handleVideo = status => {\n    if (status === CameraSourceEvents.PLAY) {\n      this.set$({\n        timerHidden: false,\n        tabCameraHidden: true,\n        cameraSelectHidden: true,\n        audioSelectHidden: true,\n        currentTimelineIcon: 'pause',\n        currentIcon: 'square',\n        mutableClassButton: 'uc-shot-btn uc-camera-action uc-stop-record'\n      });\n    }\n    if (status === CameraSourceEvents.STOP) {\n      this.set$({\n        timerHidden: false,\n        cameraHidden: true,\n        audioToggleMicrophoneHidden: true,\n        cameraActionsHidden: false\n      });\n    }\n    if (status === CameraSourceEvents.RETAKE || status === CameraSourceEvents.ACCEPT) {\n      this.set$({\n        timerHidden: true,\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        cameraHidden: false,\n        cameraActionsHidden: true,\n        audioToggleMicrophoneHidden: !this.cfg.enableAudioRecording,\n        currentIcon: 'video-camera-full',\n        mutableClassButton: 'uc-shot-btn uc-camera-action',\n        audioSelectHidden: !this.cfg.enableAudioRecording || this._audioDevices.length <= 1,\n        cameraSelectHidden: this._cameraDevices.length <= 1\n      });\n    }\n  };\n\n  /**\n   * @private\n   * @param {CameraStatus} status\n   */\n  _setCameraState = status => {\n    if (this._activeTab === CameraSourceTypes.PHOTO && (status === 'shot' || status === 'retake' || status === 'accept')) {\n      this._handlePhoto(status);\n    }\n    if (this._activeTab === CameraSourceTypes.VIDEO && (status === 'play' || status === 'stop' || status === 'retake' || status === 'accept' || status === 'pause' || status === 'resume')) {\n      this._handleVideo(status);\n    }\n  };\n\n  /** @private */\n  _shot() {\n    this._setCameraState('shot');\n    this._canvas = document.createElement('canvas');\n    this._ctx = this._canvas.getContext('2d');\n    if (!this._ctx) {\n      throw new Error('Failed to get canvas context');\n    }\n    this._canvas.height = this.ref.video['videoHeight'];\n    this._canvas.width = this.ref.video['videoWidth'];\n    if (this.cfg.cameraMirror) {\n      this._ctx.translate(this._canvas.width, 0);\n      this._ctx.scale(-1, 1);\n    }\n    this._ctx.drawImage(this.ref.video, 0, 0);\n    this.ref.video.pause();\n  }\n\n  /**\n   * @private\n   * @param {CameraMode} tabId\n   */\n  _handleActiveTab = tabId => {\n    this.ref.switcher.querySelectorAll('button').forEach((/** @type {HTMLElement} */btn) => {\n      btn.classList.toggle('uc-active', btn.getAttribute('data-id') === tabId);\n    });\n    if (tabId === CameraSourceTypes.PHOTO) {\n      this.set$({\n        currentIcon: 'camera-full',\n        audioSelectHidden: true,\n        audioToggleMicrophoneHidden: true\n      });\n    }\n    if (tabId === CameraSourceTypes.VIDEO) {\n      this.set$({\n        currentTimelineIcon: 'play',\n        currentIcon: 'video-camera-full',\n        audioSelectHidden: !this.cfg.enableAudioRecording || this._audioDevices.length <= 1,\n        audioToggleMicrophoneHidden: !this.cfg.enableAudioRecording\n      });\n    }\n    this._activeTab = tabId;\n  };\n\n  /**\n   * @param {'camera' | 'video'} type\n   * @param {'jpeg' | 'webm'} ext\n   * @param {String} format\n   * @param {Blob} blob\n   */\n  _createFile = (type, ext, format, blob) => {\n    const date = Date.now();\n    const name = `${type}-${date}.${ext}`;\n    const file = new File([blob], name, {\n      lastModified: date,\n      type: format\n    });\n    return file;\n  };\n\n  /** @param {String | undefined} mime */\n  _guessExtensionByMime(mime) {\n    const knownContainers = {\n      mp4: 'mp4',\n      ogg: 'ogg',\n      webm: 'webm',\n      quicktime: 'mov',\n      'x-matroska': 'mkv'\n    };\n\n    // MediaRecorder.mimeType returns empty string in Firefox.\n    // Firefox record video as WebM now by default.\n    // @link https://bugzilla.mozilla.org/show_bug.cgi?id=1512175\n    if (mime === '') {\n      return 'webm';\n    }\n\n    // e.g. \"video/x-matroska;codecs=avc1,opus\"\n    if (mime) {\n      // e.g. [\"video\", \"x-matroska;codecs=avc1,opus\"]\n      /** @type {string | string[]} */\n      mime = mime.split('/');\n      if (mime?.[0] === 'video') {\n        // e.g. \"x-matroska;codecs=avc1,opus\"\n        mime = mime.slice(1).join('/');\n        // e.g. \"x-matroska\"\n        const container = mime?.split(';')[0];\n        // e.g. \"mkv\"\n        if (knownContainers[container]) {\n          return knownContainers[container];\n        }\n      }\n    }\n\n    // In all other cases just return the base extension for all times\n    return 'avi';\n  }\n\n  /**\n   * The send file to the server\n   *\n   * @param {File} file\n   */\n  _toSend = file => {\n    this.api.addFileFromObject(file, {\n      source: UploadSource.CAMERA\n    });\n    this.set$({\n      '*currentActivity': ActivityBlock.activities.UPLOAD_LIST\n    });\n    this.modalManager.open(ActivityBlock.activities.UPLOAD_LIST);\n  };\n\n  /** @private */\n  get _cameraModes() {\n    return stringToArray(this.cfg.cameraModes);\n  }\n\n  /**\n   * @private\n   * @param {'granted' | 'denied' | 'prompt'} state\n   */\n  _setPermissionsState = debounce(state => {\n    this.classList.toggle('uc-initialized', state === 'granted');\n    const visibleAudio = this._activeTab === CameraSourceTypes.VIDEO && this.cfg.enableAudioRecording;\n    const currentIcon = this._activeTab === CameraSourceTypes.PHOTO ? 'camera-full' : 'video-camera-full';\n    if (state === 'granted') {\n      this.set$({\n        videoHidden: false,\n        cameraHidden: false,\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        messageHidden: true,\n        timerHidden: true,\n        currentIcon,\n        audioToggleMicrophoneHidden: !visibleAudio,\n        audioSelectHidden: !visibleAudio\n      });\n    } else if (state === 'prompt') {\n      this.$.l10nMessage = 'camera-permissions-prompt';\n      this.set$({\n        videoHidden: true,\n        cameraHidden: true,\n        tabCameraHidden: true,\n        messageHidden: false\n      });\n      this._stopCapture();\n    } else {\n      this.$.l10nMessage = 'camera-permissions-denied';\n      this.set$({\n        videoHidden: true,\n        messageHidden: false,\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        cameraActionsHidden: true,\n        mutableClassButton: 'uc-shot-btn uc-camera-action'\n      });\n      this._stopCapture();\n    }\n  }, 300);\n  _makeStreamInactive = () => {\n    if (!this._stream) return false;\n    const audioTracks = this._stream?.getAudioTracks();\n    const videoTracks = this._stream?.getVideoTracks();\n\n    /** @type {MediaStreamTrack[]} */\n    audioTracks.forEach(track => track.stop());\n    /** @type {MediaStreamTrack[]} */\n    videoTracks.forEach(track => track.stop());\n  };\n  _stopCapture = () => {\n    if (this._capturing) {\n      this.ref.video.volume = 0;\n      this.$.video?.getTracks()[0].stop();\n      this.$.video = null;\n      this._makeStreamInactive();\n      this._stopTimer();\n      this._capturing = false;\n    }\n  };\n  _capture = async () => {\n    const constraints = {\n      video: DEFAULT_VIDEO_CONFIG,\n      audio: this.cfg.enableAudioRecording ? {} : false\n    };\n    if (this._selectedCameraId) {\n      constraints.video = {\n        deviceId: {\n          exact: this._selectedCameraId\n        }\n      };\n    }\n    if (this._selectedAudioId && this.cfg.enableAudioRecording) {\n      constraints.audio = {\n        deviceId: {\n          exact: this._selectedAudioId\n        }\n      };\n    }\n\n    // Mute the video to prevent feedback for Firefox\n    this.ref.video.volume = 0;\n    try {\n      this._setPermissionsState('prompt');\n      this._stream = await navigator.mediaDevices.getUserMedia(constraints);\n      this._stream.addEventListener('inactive', () => {\n        this._setPermissionsState('denied');\n      });\n      this.$.video = this._stream;\n      /** @private */\n      this._capturing = true;\n      this._setPermissionsState('granted');\n    } catch (error) {\n      this._setPermissionsState('denied');\n      console.log('Failed to capture camera', error);\n    }\n  };\n  _handlePermissionsChange = () => {\n    this._capture();\n  };\n  _permissionAccess = async () => {\n    try {\n      for (const permission of DEFAULT_PERMISSIONS) {\n        // @ts-ignore  https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API\n        this[`${permission}Response`] = await navigator.permissions.query({\n          name: permission\n        });\n        this[`${permission}Response`].addEventListener('change', this._handlePermissionsChange);\n      }\n    } catch (error) {\n      console.log('Failed to use permissions API. Fallback to manual request mode.', error);\n      this._capture();\n    }\n  };\n  _getPermission = () => {};\n  _requestDeviceAccess = async () => {\n    try {\n      await navigator.mediaDevices.getUserMedia({\n        video: true,\n        audio: this.cfg.enableAudioRecording\n      });\n      await this._getDevices();\n      navigator.mediaDevices.addEventListener('devicechange', this._getDevices);\n    } catch (error) {\n      console.log('Failed to get user media', error);\n    }\n  };\n  _getDevices = async () => {\n    try {\n      const devices = await navigator.mediaDevices.enumerateDevices();\n      this._cameraDevices = devices.filter(device => device.kind === 'videoinput').map((device, index) => ({\n        text: device.label.trim() || `${this.l10n('caption-camera')} ${index + 1}`,\n        value: device.deviceId\n      }));\n      this._audioDevices = this.cfg.enableAudioRecording && devices.filter(device => device.kind === 'audioinput').map(device => ({\n        text: device.label.trim(),\n        value: device.deviceId\n      }));\n      if (this._cameraDevices.length > 1) {\n        this.set$({\n          cameraSelectOptions: this._cameraDevices,\n          cameraSelectHidden: false\n        });\n      }\n      this._selectedCameraId = this._cameraDevices[0]?.value;\n      if (this._audioDevices.length > 1) {\n        this.set$({\n          audioSelectOptions: this._audioDevices,\n          audioSelectHidden: false\n        });\n      }\n      this._selectedAudioId = this._audioDevices[0]?.value;\n    } catch (error) {\n      console.log('Failed to get devices', error);\n    }\n  };\n  _onActivate = async () => {\n    await this._permissionAccess();\n    await this._requestDeviceAccess();\n    await this._capture();\n    this._handleCameraModes(this._cameraModes);\n  };\n  _onDeactivate = async () => {\n    if (this._unsubPermissions) {\n      this._unsubPermissions();\n    }\n\n    /** Calling this method here because safari and firefox don't support the inactive event yet */\n    const isChromium = !!window.chrome;\n    if (!isChromium) {\n      this._setPermissionsState('denied');\n    }\n    this._stopCapture();\n  };\n\n  /** @param {CameraMode[]} cameraModes */\n  _handleCameraModes = cameraModes => {\n    this.$.tabVideoHidden = !cameraModes.includes(CameraSourceTypes.VIDEO);\n    this.$.tabCameraHidden = !cameraModes.includes(CameraSourceTypes.PHOTO);\n    const defaultTab = cameraModes[0];\n    if (!this._activeTab || !cameraModes.includes(this._activeTab)) {\n      this._handleActiveTab(defaultTab);\n    }\n  };\n  initCallback() {\n    super.initCallback();\n    this.registerActivity(this.activityType, {\n      onActivate: this._onActivate,\n      onDeactivate: this._onDeactivate\n    });\n    this.subConfigValue('cameraMirror', val => {\n      this.$.videoTransformCss = val ? 'scaleX(-1)' : null;\n    });\n    this.subConfigValue('enableAudioRecording', val => {\n      this.$.audioToggleMicrophoneHidden = !val;\n      this.$.audioSelectDisabled = !val;\n    });\n    this.subConfigValue('cameraModes', val => {\n      if (!this.isActivityActive) return;\n      const cameraModes = deserializeCsv(val);\n      this._handleCameraModes(cameraModes);\n    });\n  }\n  _destroy() {\n    for (const permission of DEFAULT_PERMISSIONS) {\n      this[`${permission}Response`]?.removeEventListener('change', this._handlePermissionsChange);\n    }\n    navigator.mediaDevices?.removeEventListener('devicechange', this._getDevices);\n  }\n  async destroyCallback() {\n    super.destroyCallback();\n    this._destroy();\n  }\n}\nCameraSource.template = /* HTML */`\n  <uc-activity-header>\n    <button type=\"button\" class=\"uc-mini-btn\" set=\"onclick: *historyBack\" l10n=\"@title:back\">\n      <uc-icon name=\"back\"></uc-icon>\n    </button>\n    <div set=\"@hidden: !cameraSelectHidden\">\n      <uc-icon name=\"camera\"></uc-icon>\n      <span l10n=\"caption-camera\"></span>\n    </div>\n    <uc-select\n      class=\"uc-camera-select\"\n      set=\"$.options: cameraSelectOptions; @hidden: cameraSelectHidden; onchange: onCameraSelectChange\"\n    >\n    </uc-select>\n    <button\n      type=\"button\"\n      class=\"uc-mini-btn uc-close-btn\"\n      set=\"onclick: *closeModal\"\n      l10n=\"@title:a11y-activity-header-button-close;@aria-label:a11y-activity-header-button-close\"\n    >\n      <uc-icon name=\"close\"></uc-icon>\n    </button>\n  </uc-activity-header>\n  <div class=\"uc-content\">\n    <video\n      muted\n      autoplay\n      playsinline\n      set=\"srcObject: video; style.transform: videoTransformCss; @hidden: videoHidden\"\n      ref=\"video\"\n    ></video>\n    <div class=\"uc-message-box\" set=\"@hidden: messageHidden\">\n      <span l10n=\"l10nMessage\"></span>\n      <button\n        type=\"button\"\n        set=\"onclick: onRequestPermissions; @hidden: requestBtnHidden\"\n        l10n=\"camera-permissions-request\"\n      ></button>\n    </div>\n  </div>\n\n  <div class=\"uc-controls\">\n    <div ref=\"switcher\" class=\"uc-switcher\" set=\"@hidden:!timerHidden\">\n      <button\n        data-id=\"photo\"\n        type=\"button\"\n        class=\"uc-switch uc-mini-btn\"\n        set=\"onclick: onClickTab;  @hidden: tabCameraHidden\"\n      >\n        <uc-icon name=\"camera\"></uc-icon>\n      </button>\n      <button\n        data-id=\"video\"\n        type=\"button\"\n        class=\"uc-switch uc-mini-btn\"\n        set=\"onclick: onClickTab; @hidden: tabVideoHidden\"\n      >\n        <uc-icon name=\"video-camera\"></uc-icon>\n      </button>\n    </div>\n\n    <button class=\"uc-secondary-btn uc-recording-timer\" set=\"@hidden:timerHidden; onclick: onToggleRecording\">\n      <uc-icon set=\"@name: currentTimelineIcon\"></uc-icon>\n      <span ref=\"timer\"> 00:00 </span>\n      <span ref=\"line\" class=\"uc-line\"></span>\n    </button>\n\n    <div class=\"uc-camera-actions uc-camera-action\" set=\"@hidden: cameraActionsHidden\">\n      <button type=\"button\" class=\"uc-secondary-btn\" set=\"onclick: onRetake\">Retake</button>\n      <button type=\"button\" class=\"uc-primary-btn\" set=\"onclick: onAccept\" data-testid=\"accept\">Accept</button>\n    </div>\n\n    <button\n      type=\"button\"\n      class=\"uc-shot-btn uc-camera-action\"\n      data-testid=\"shot\"\n      set=\"onclick: onStartCamera; @class: mutableClassButton; @hidden: cameraHidden;\"\n    >\n      <uc-icon set=\"@name: currentIcon\"></uc-icon>\n    </button>\n\n    <div class=\"uc-select\">\n      <button class=\"uc-mini-btn uc-btn-microphone\" set=\"onclick: onToggleAudio; @hidden: audioToggleMicrophoneHidden;\">\n        <uc-icon set=\"@name:toggleMicrophoneIcon\"></uc-icon>\n      </button>\n\n      <uc-select\n        class=\"uc-audio-select\"\n        set=\"$.options: audioSelectOptions; onchange: onAudioSelectChange; @hidden: audioSelectHidden; @disabled: audioSelectDisabled\"\n      >\n      </uc-select>\n    </div>\n  </div>\n`;","map":{"version":3,"names":["ActivityBlock","UploaderBlock","stringToArray","canUsePermissionsApi","deserializeCsv","debounce","UploadSource","CameraSourceEvents","CameraSourceTypes","DEFAULT_VIDEO_CONFIG","width","ideal","height","frameRate","DEFAULT_PERMISSIONS","formatTime","time","minutes","Math","floor","toString","padStart","seconds","DEFAULT_PICTURE_FORMAT","DEFAULT_VIDEO_FORMAT","CameraSource","couldBeCtxOwner","activityType","activities","CAMERA","_unsubPermissions","_chunks","_mediaRecorder","_stream","_selectedAudioId","_selectedCameraId","constructor","init$","video","videoTransformCss","videoHidden","messageHidden","requestBtnHidden","cameraSelectOptions","cameraSelectHidden","l10nMessage","switcher","panels","timer","timerHidden","cameraHidden","cameraActionsHidden","audioSelectOptions","audioSelectHidden","audioSelectDisabled","audioToggleMicrophoneHidden","tabCameraHidden","tabVideoHidden","currentIcon","currentTimelineIcon","toggleMicrophoneIcon","_startTime","_elapsedTime","_animationFrameId","mutableClassButton","onCameraSelectChange","e","target","value","_capture","onAudioSelectChange","onCancel","historyBack","onShot","_shot","onRequestPermissions","onStartCamera","_chooseActionWithCamera","onStartRecording","_startRecording","onStopRecording","_stopRecording","onToggleRecording","_toggleRecording","onToggleAudio","_toggleEnableAudio","onRetake","_retake","onAccept","_accept","onClickTab","id","currentTarget","getAttribute","_handleActiveTab","_activeTab","PHOTO","VIDEO","state","_updateTimer","currentTime","performance","now","$","cfg","maxVideoRecordingDuration","remainingTime","ref","textContent","requestAnimationFrame","_startTimer","_stopTimer","cancelAnimationFrame","_startTimeline","duration","line","style","transform","_stopTimeline","_options","mediaRecorderOptions","mimeType","MediaRecorder","isTypeSupported","start","addEventListener","push","data","classList","add","_setCameraState","PLAY","error","console","_previewVideo","STOP","stop","remove","paused","ended","readyState","pause","play","getAudioTracks","forEach","track","enabled","blob","Blob","type","videoURL","URL","createObjectURL","muted","volume","src","set$","RETAKE","ACCEPT","_canvas","toBlob","file","_createFile","_toSend","ext","_guessExtensionByMime","_handlePhoto","status","SHOT","_cameraModes","includes","_cameraDevices","length","_handleVideo","enableAudioRecording","_audioDevices","document","createElement","_ctx","getContext","Error","cameraMirror","translate","scale","drawImage","tabId","querySelectorAll","btn","toggle","format","date","Date","name","File","lastModified","mime","knownContainers","mp4","ogg","webm","quicktime","split","slice","join","container","api","addFileFromObject","source","UPLOAD_LIST","modalManager","open","cameraModes","_setPermissionsState","visibleAudio","_stopCapture","_makeStreamInactive","audioTracks","videoTracks","getVideoTracks","_capturing","getTracks","constraints","audio","deviceId","exact","navigator","mediaDevices","getUserMedia","log","_handlePermissionsChange","_permissionAccess","permission","permissions","query","_getPermission","_requestDeviceAccess","_getDevices","devices","enumerateDevices","filter","device","kind","map","index","text","label","trim","l10n","_onActivate","_handleCameraModes","_onDeactivate","isChromium","window","chrome","defaultTab","initCallback","registerActivity","onActivate","onDeactivate","subConfigValue","val","isActivityActive","_destroy","removeEventListener","destroyCallback","template"],"sources":["/Users/kavinth/Documents/GitHub/Smart-Alert/Smart-Alert-new/frontend/node_modules/@uploadcare/file-uploader/blocks/CameraSource/CameraSource.js"],"sourcesContent":["//@ts-nocheck\nimport { ActivityBlock } from '../../abstract/ActivityBlock.js';\nimport { UploaderBlock } from '../../abstract/UploaderBlock.js';\nimport { stringToArray } from '../../utils/stringToArray.js';\nimport { canUsePermissionsApi } from '../utils/abilities.js';\nimport { deserializeCsv } from '../utils/comma-separated.js';\nimport { debounce } from '../utils/debounce.js';\nimport { UploadSource } from '../utils/UploadSource.js';\nimport { CameraSourceEvents, CameraSourceTypes } from './constants.js';\n\nconst DEFAULT_VIDEO_CONFIG = {\n  width: {\n    ideal: 1920,\n  },\n  height: {\n    ideal: 1080,\n  },\n  frameRate: {\n    ideal: 30,\n  },\n};\n\nconst DEFAULT_PERMISSIONS = ['camera', 'microphone'];\n\n/**\n * @param {Number} time\n * @returns\n */\nfunction formatTime(time) {\n  const minutes = Math.floor(time / 60)\n    .toString()\n    .padStart(2, '0');\n  const seconds = Math.floor(time % 60)\n    .toString()\n    .padStart(2, '0');\n  return `${minutes}:${seconds}`;\n}\n\nconst DEFAULT_PICTURE_FORMAT = 'image/jpeg';\nconst DEFAULT_VIDEO_FORMAT = 'video/webm';\n\n/** @typedef {'photo' | 'video'} CameraMode */\n\n/** @typedef {'shot' | 'retake' | 'accept' | 'play' | 'stop' | 'pause' | 'resume'} CameraStatus */\n\nexport class CameraSource extends UploaderBlock {\n  couldBeCtxOwner = true;\n  activityType = ActivityBlock.activities.CAMERA;\n\n  /** @private */\n  _unsubPermissions = null;\n\n  /** @type {BlobPart[]} */\n  _chunks = [];\n\n  /** @type {MediaRecorder | null} */\n  _mediaRecorder = null;\n\n  /** @type {MediaStream | null} */\n  _stream = null;\n\n  /** @type {string | null} */\n  _selectedAudioId = null;\n\n  /** @type {string | null} */\n  _selectedCameraId = null;\n\n  constructor() {\n    super();\n\n    this.init$ = {\n      ...this.init$,\n      video: null,\n      videoTransformCss: null,\n\n      videoHidden: true,\n      messageHidden: true,\n      requestBtnHidden: canUsePermissionsApi(),\n      cameraSelectOptions: null,\n      cameraSelectHidden: true,\n      l10nMessage: '',\n\n      // This is refs\n      switcher: null,\n      panels: null,\n      timer: null,\n\n      timerHidden: true,\n      cameraHidden: true,\n      cameraActionsHidden: true,\n\n      audioSelectOptions: null,\n      audioSelectHidden: true,\n      audioSelectDisabled: true,\n      audioToggleMicrophoneHidden: true,\n\n      tabCameraHidden: true,\n      tabVideoHidden: true,\n\n      currentIcon: 'camera-full',\n      currentTimelineIcon: 'play',\n      toggleMicrophoneIcon: 'microphone',\n\n      /** @type {Number} */\n      _startTime: 0,\n      /** @type {Number} */\n      _elapsedTime: 0,\n      _animationFrameId: null,\n\n      mutableClassButton: 'uc-shot-btn uc-camera-action',\n\n      /** @param {Event} e */\n      onCameraSelectChange: (e) => {\n        this._selectedCameraId = e.target.value;\n        this._capture();\n      },\n\n      /** @param {Event} e */\n      onAudioSelectChange: (e) => {\n        this._selectedAudioId = e.target.value;\n        this._capture();\n      },\n\n      onCancel: () => {\n        this.historyBack();\n      },\n\n      onShot: () => this._shot(),\n\n      onRequestPermissions: () => this._capture(),\n\n      /** General method for photo and video capture */\n      onStartCamera: () => this._chooseActionWithCamera(),\n\n      onStartRecording: () => this._startRecording(),\n\n      onStopRecording: () => this._stopRecording(),\n\n      onToggleRecording: () => this._toggleRecording(),\n\n      onToggleAudio: () => this._toggleEnableAudio(),\n\n      onRetake: () => this._retake(),\n\n      onAccept: () => this._accept(),\n\n      /** @param {MouseEvent} e */\n      onClickTab: (e) => {\n        const id = /** @type {HTMLElement} */ (e.currentTarget).getAttribute('data-id');\n        if (id) this._handleActiveTab(/** @type {CameraMode} */ (id));\n      },\n    };\n  }\n\n  _chooseActionWithCamera = () => {\n    if (this._activeTab === CameraSourceTypes.PHOTO) {\n      this._shot();\n    }\n\n    if (this._activeTab === CameraSourceTypes.VIDEO) {\n      if (this._mediaRecorder?.state === 'recording') {\n        this._stopRecording();\n        return;\n      }\n\n      this._startRecording();\n    }\n  };\n\n  _updateTimer = () => {\n    const currentTime = Math.floor((performance.now() - this.$._startTime + this.$._elapsedTime) / 1000);\n\n    if (typeof this.cfg.maxVideoRecordingDuration === 'number' && this.cfg.maxVideoRecordingDuration > 0) {\n      const remainingTime = this.cfg.maxVideoRecordingDuration - currentTime;\n\n      if (remainingTime <= 0) {\n        this.ref.timer.textContent = formatTime(remainingTime);\n        this._stopRecording();\n        return;\n      }\n\n      this.ref.timer.textContent = formatTime(remainingTime);\n    } else {\n      this.ref.timer.textContent = formatTime(currentTime);\n    }\n\n    this._animationFrameId = requestAnimationFrame(this._updateTimer);\n  };\n\n  _startTimer = () => {\n    this.$._startTime = performance.now();\n    this.$._elapsedTime = 0;\n\n    this._updateTimer();\n  };\n\n  _stopTimer = () => {\n    if (this._animationFrameId) cancelAnimationFrame(this._animationFrameId);\n  };\n\n  _startTimeline = () => {\n    const currentTime = this.ref.video.currentTime;\n    const duration = this.ref.video.duration;\n\n    this.ref.line.style.transform = `scaleX(${currentTime / duration})`;\n    this.ref.timer.textContent = formatTime(currentTime);\n    this._animationFrameId = requestAnimationFrame(this._startTimeline);\n  };\n\n  _stopTimeline = () => {\n    if (this._animationFrameId) cancelAnimationFrame(this._animationFrameId);\n  };\n\n  _startRecording = () => {\n    try {\n      this._chunks = [];\n      this._options = {\n        ...this.cfg.mediaRecorderOptions,\n      };\n\n      const { mimeType } = this.cfg.mediaRecorderOptions || {};\n\n      if (mimeType && MediaRecorder.isTypeSupported(mimeType)) {\n        this._options.mimeType = mimeType;\n      } else if (MediaRecorder.isTypeSupported(DEFAULT_VIDEO_FORMAT)) {\n        this._options.mimeType = DEFAULT_VIDEO_FORMAT;\n      } else {\n        this._options.mimeType = 'video/mp4';\n      }\n\n      if (this._stream) {\n        this._mediaRecorder = new MediaRecorder(this._stream, this._options);\n        this._mediaRecorder.start();\n\n        this._mediaRecorder.addEventListener('dataavailable', (e) => {\n          this._chunks.push(e.data);\n        });\n\n        this._startTimer();\n\n        this.classList.add('uc-recording');\n        this._setCameraState(CameraSourceEvents.PLAY);\n      }\n    } catch (error) {\n      console.error('Failed to start recording', error);\n    }\n  };\n\n  /** @private */\n  _stopRecording = () => {\n    this._mediaRecorder?.addEventListener('stop', () => {\n      this._previewVideo();\n\n      this._stopTimer();\n\n      this._setCameraState(CameraSourceEvents.STOP);\n    });\n\n    this._mediaRecorder?.stop();\n    this.classList.remove('uc-recording');\n  };\n\n  /** This method is used to toggle recording pause/resume */\n  _toggleRecording = () => {\n    if (this._mediaRecorder?.state === 'recording') return;\n\n    if (!this.ref.video.paused && !this.ref.video.ended && this.ref.video.readyState > 2) {\n      this.ref.video.pause();\n    } else if (this.ref.video.paused) {\n      this.ref.video.play();\n    }\n  };\n\n  _toggleEnableAudio = () => {\n    this._stream?.getAudioTracks().forEach((track) => {\n      track.enabled = !track.enabled;\n\n      this.$.toggleMicrophoneIcon = !track.enabled ? 'microphone-mute' : 'microphone';\n      this.$.audioSelectDisabled = !track.enabled;\n    });\n  };\n\n  /**\n   * Previewing the video that was recorded on the camera\n   *\n   * @private\n   */\n  _previewVideo = () => {\n    try {\n      const blob = new Blob(this._chunks, {\n        type: this._mediaRecorder?.mimeType,\n      });\n\n      const videoURL = URL.createObjectURL(blob);\n\n      this.ref.video.muted = false;\n      this.ref.video.volume = 1;\n      this.$.video = null;\n      this.ref.video.src = videoURL;\n\n      this.ref.video.addEventListener('play', () => {\n        this._startTimeline();\n        this.set$({\n          currentTimelineIcon: 'pause',\n        });\n      });\n\n      this.ref.video.addEventListener('pause', () => {\n        this.set$({\n          currentTimelineIcon: 'play',\n        });\n        this._stopTimeline();\n      });\n    } catch (error) {\n      console.error('Failed to preview video', error);\n    }\n  };\n\n  _retake = () => {\n    this._setCameraState(CameraSourceEvents.RETAKE);\n\n    /** Reset video */\n    if (this._activeTab === CameraSourceTypes.VIDEO) {\n      this.$.video = this._stream;\n      this.ref.video.muted = true;\n    }\n\n    this.ref.video.play();\n  };\n\n  _accept = () => {\n    this._setCameraState(CameraSourceEvents.ACCEPT);\n\n    if (this._activeTab === CameraSourceTypes.PHOTO) {\n      this._canvas?.toBlob((blob) => {\n        const file = this._createFile('camera', 'jpeg', DEFAULT_PICTURE_FORMAT, blob);\n        this._toSend(file);\n      }, DEFAULT_PICTURE_FORMAT);\n      return;\n    }\n\n    const blob = new Blob(this._chunks, {\n      type: this._mediaRecorder?.mimeType,\n    });\n\n    const ext = this._guessExtensionByMime(this._mediaRecorder?.mimeType);\n    const file = this._createFile('video', ext, `video/${ext}`, blob);\n\n    this._toSend(file);\n    this._chunks = [];\n  };\n\n  /** @param {CameraStatus} status */\n  _handlePhoto = (status) => {\n    if (status === CameraSourceEvents.SHOT) {\n      this.set$({\n        tabVideoHidden: true,\n        cameraHidden: true,\n        tabCameraHidden: true,\n        cameraActionsHidden: false,\n        cameraSelectHidden: true,\n      });\n    }\n\n    if (status === CameraSourceEvents.RETAKE || status === CameraSourceEvents.ACCEPT) {\n      this.set$({\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        cameraHidden: false,\n        cameraActionsHidden: true,\n        cameraSelectHidden: this._cameraDevices.length <= 1,\n      });\n    }\n  };\n\n  /** @param {CameraStatus} status */\n  _handleVideo = (status) => {\n    if (status === CameraSourceEvents.PLAY) {\n      this.set$({\n        timerHidden: false,\n        tabCameraHidden: true,\n\n        cameraSelectHidden: true,\n        audioSelectHidden: true,\n\n        currentTimelineIcon: 'pause',\n        currentIcon: 'square',\n        mutableClassButton: 'uc-shot-btn uc-camera-action uc-stop-record',\n      });\n    }\n\n    if (status === CameraSourceEvents.STOP) {\n      this.set$({\n        timerHidden: false,\n        cameraHidden: true,\n        audioToggleMicrophoneHidden: true,\n        cameraActionsHidden: false,\n      });\n    }\n\n    if (status === CameraSourceEvents.RETAKE || status === CameraSourceEvents.ACCEPT) {\n      this.set$({\n        timerHidden: true,\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        cameraHidden: false,\n        cameraActionsHidden: true,\n        audioToggleMicrophoneHidden: !this.cfg.enableAudioRecording,\n        currentIcon: 'video-camera-full',\n        mutableClassButton: 'uc-shot-btn uc-camera-action',\n\n        audioSelectHidden: !this.cfg.enableAudioRecording || this._audioDevices.length <= 1,\n        cameraSelectHidden: this._cameraDevices.length <= 1,\n      });\n    }\n  };\n\n  /**\n   * @private\n   * @param {CameraStatus} status\n   */\n  _setCameraState = (status) => {\n    if (\n      this._activeTab === CameraSourceTypes.PHOTO &&\n      (status === 'shot' || status === 'retake' || status === 'accept')\n    ) {\n      this._handlePhoto(status);\n    }\n\n    if (\n      this._activeTab === CameraSourceTypes.VIDEO &&\n      (status === 'play' ||\n        status === 'stop' ||\n        status === 'retake' ||\n        status === 'accept' ||\n        status === 'pause' ||\n        status === 'resume')\n    ) {\n      this._handleVideo(status);\n    }\n  };\n\n  /** @private */\n  _shot() {\n    this._setCameraState('shot');\n\n    this._canvas = document.createElement('canvas');\n    this._ctx = this._canvas.getContext('2d');\n\n    if (!this._ctx) {\n      throw new Error('Failed to get canvas context');\n    }\n\n    this._canvas.height = this.ref.video['videoHeight'];\n    this._canvas.width = this.ref.video['videoWidth'];\n\n    if (this.cfg.cameraMirror) {\n      this._ctx.translate(this._canvas.width, 0);\n      this._ctx.scale(-1, 1);\n    }\n\n    this._ctx.drawImage(this.ref.video, 0, 0);\n    this.ref.video.pause();\n  }\n\n  /**\n   * @private\n   * @param {CameraMode} tabId\n   */\n  _handleActiveTab = (tabId) => {\n    this.ref.switcher.querySelectorAll('button').forEach((/** @type {HTMLElement} */ btn) => {\n      btn.classList.toggle('uc-active', btn.getAttribute('data-id') === tabId);\n    });\n\n    if (tabId === CameraSourceTypes.PHOTO) {\n      this.set$({\n        currentIcon: 'camera-full',\n        audioSelectHidden: true,\n        audioToggleMicrophoneHidden: true,\n      });\n    }\n\n    if (tabId === CameraSourceTypes.VIDEO) {\n      this.set$({\n        currentTimelineIcon: 'play',\n        currentIcon: 'video-camera-full',\n\n        audioSelectHidden: !this.cfg.enableAudioRecording || this._audioDevices.length <= 1,\n        audioToggleMicrophoneHidden: !this.cfg.enableAudioRecording,\n      });\n    }\n\n    this._activeTab = tabId;\n  };\n\n  /**\n   * @param {'camera' | 'video'} type\n   * @param {'jpeg' | 'webm'} ext\n   * @param {String} format\n   * @param {Blob} blob\n   */\n  _createFile = (type, ext, format, blob) => {\n    const date = Date.now();\n    const name = `${type}-${date}.${ext}`;\n\n    const file = new File([blob], name, {\n      lastModified: date,\n      type: format,\n    });\n\n    return file;\n  };\n\n  /** @param {String | undefined} mime */\n  _guessExtensionByMime(mime) {\n    const knownContainers = {\n      mp4: 'mp4',\n      ogg: 'ogg',\n      webm: 'webm',\n      quicktime: 'mov',\n      'x-matroska': 'mkv',\n    };\n\n    // MediaRecorder.mimeType returns empty string in Firefox.\n    // Firefox record video as WebM now by default.\n    // @link https://bugzilla.mozilla.org/show_bug.cgi?id=1512175\n    if (mime === '') {\n      return 'webm';\n    }\n\n    // e.g. \"video/x-matroska;codecs=avc1,opus\"\n    if (mime) {\n      // e.g. [\"video\", \"x-matroska;codecs=avc1,opus\"]\n      /** @type {string | string[]} */ (mime) = mime.split('/');\n      if (mime?.[0] === 'video') {\n        // e.g. \"x-matroska;codecs=avc1,opus\"\n        mime = mime.slice(1).join('/');\n        // e.g. \"x-matroska\"\n        const container = mime?.split(';')[0];\n        // e.g. \"mkv\"\n        if (knownContainers[container]) {\n          return knownContainers[container];\n        }\n      }\n    }\n\n    // In all other cases just return the base extension for all times\n    return 'avi';\n  }\n\n  /**\n   * The send file to the server\n   *\n   * @param {File} file\n   */\n  _toSend = (file) => {\n    this.api.addFileFromObject(file, { source: UploadSource.CAMERA });\n    this.set$({\n      '*currentActivity': ActivityBlock.activities.UPLOAD_LIST,\n    });\n    this.modalManager.open(ActivityBlock.activities.UPLOAD_LIST);\n  };\n\n  /** @private */\n  get _cameraModes() {\n    return stringToArray(this.cfg.cameraModes);\n  }\n\n  /**\n   * @private\n   * @param {'granted' | 'denied' | 'prompt'} state\n   */\n  _setPermissionsState = debounce((state) => {\n    this.classList.toggle('uc-initialized', state === 'granted');\n\n    const visibleAudio = this._activeTab === CameraSourceTypes.VIDEO && this.cfg.enableAudioRecording;\n    const currentIcon = this._activeTab === CameraSourceTypes.PHOTO ? 'camera-full' : 'video-camera-full';\n\n    if (state === 'granted') {\n      this.set$({\n        videoHidden: false,\n        cameraHidden: false,\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n        messageHidden: true,\n        timerHidden: true,\n\n        currentIcon,\n        audioToggleMicrophoneHidden: !visibleAudio,\n        audioSelectHidden: !visibleAudio,\n      });\n    } else if (state === 'prompt') {\n      this.$.l10nMessage = 'camera-permissions-prompt';\n\n      this.set$({\n        videoHidden: true,\n        cameraHidden: true,\n        tabCameraHidden: true,\n        messageHidden: false,\n      });\n\n      this._stopCapture();\n    } else {\n      this.$.l10nMessage = 'camera-permissions-denied';\n\n      this.set$({\n        videoHidden: true,\n        messageHidden: false,\n\n        tabCameraHidden: !this._cameraModes.includes(CameraSourceTypes.PHOTO),\n        tabVideoHidden: !this._cameraModes.includes(CameraSourceTypes.VIDEO),\n\n        cameraActionsHidden: true,\n\n        mutableClassButton: 'uc-shot-btn uc-camera-action',\n      });\n\n      this._stopCapture();\n    }\n  }, 300);\n\n  _makeStreamInactive = () => {\n    if (!this._stream) return false;\n\n    const audioTracks = this._stream?.getAudioTracks();\n    const videoTracks = this._stream?.getVideoTracks();\n\n    /** @type {MediaStreamTrack[]} */ (audioTracks).forEach((track) => track.stop());\n    /** @type {MediaStreamTrack[]} */ (videoTracks).forEach((track) => track.stop());\n  };\n\n  _stopCapture = () => {\n    if (this._capturing) {\n      this.ref.video.volume = 0;\n      this.$.video?.getTracks()[0].stop();\n      this.$.video = null;\n\n      this._makeStreamInactive();\n      this._stopTimer();\n\n      this._capturing = false;\n    }\n  };\n\n  _capture = async () => {\n    const constraints = {\n      video: DEFAULT_VIDEO_CONFIG,\n      audio: this.cfg.enableAudioRecording ? {} : false,\n    };\n\n    if (this._selectedCameraId) {\n      constraints.video = {\n        deviceId: {\n          exact: this._selectedCameraId,\n        },\n      };\n    }\n\n    if (this._selectedAudioId && this.cfg.enableAudioRecording) {\n      constraints.audio = {\n        deviceId: {\n          exact: this._selectedAudioId,\n        },\n      };\n    }\n\n    // Mute the video to prevent feedback for Firefox\n    this.ref.video.volume = 0;\n\n    try {\n      this._setPermissionsState('prompt');\n      this._stream = await navigator.mediaDevices.getUserMedia(constraints);\n\n      this._stream.addEventListener('inactive', () => {\n        this._setPermissionsState('denied');\n      });\n\n      this.$.video = this._stream;\n      /** @private */\n      this._capturing = true;\n      this._setPermissionsState('granted');\n    } catch (error) {\n      this._setPermissionsState('denied');\n      console.log('Failed to capture camera', error);\n    }\n  };\n\n  _handlePermissionsChange = () => {\n    this._capture();\n  };\n\n  _permissionAccess = async () => {\n    try {\n      for (const permission of DEFAULT_PERMISSIONS) {\n        // @ts-ignore  https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API\n        this[`${permission}Response`] = await navigator.permissions.query({ name: permission });\n\n        this[`${permission}Response`].addEventListener('change', this._handlePermissionsChange);\n      }\n    } catch (error) {\n      console.log('Failed to use permissions API. Fallback to manual request mode.', error);\n      this._capture();\n    }\n  };\n\n  _getPermission = () => {};\n\n  _requestDeviceAccess = async () => {\n    try {\n      await navigator.mediaDevices.getUserMedia({ video: true, audio: this.cfg.enableAudioRecording });\n      await this._getDevices();\n\n      navigator.mediaDevices.addEventListener('devicechange', this._getDevices);\n    } catch (error) {\n      console.log('Failed to get user media', error);\n    }\n  };\n\n  _getDevices = async () => {\n    try {\n      const devices = await navigator.mediaDevices.enumerateDevices();\n\n      this._cameraDevices = devices\n        .filter((device) => device.kind === 'videoinput')\n        .map((device, index) => ({\n          text: device.label.trim() || `${this.l10n('caption-camera')} ${index + 1}`,\n          value: device.deviceId,\n        }));\n\n      this._audioDevices =\n        this.cfg.enableAudioRecording &&\n        devices\n          .filter((device) => device.kind === 'audioinput')\n          .map((device) => ({\n            text: device.label.trim(),\n            value: device.deviceId,\n          }));\n\n      if (this._cameraDevices.length > 1) {\n        this.set$({\n          cameraSelectOptions: this._cameraDevices,\n          cameraSelectHidden: false,\n        });\n      }\n      this._selectedCameraId = this._cameraDevices[0]?.value;\n\n      if (this._audioDevices.length > 1) {\n        this.set$({\n          audioSelectOptions: this._audioDevices,\n          audioSelectHidden: false,\n        });\n      }\n      this._selectedAudioId = this._audioDevices[0]?.value;\n    } catch (error) {\n      console.log('Failed to get devices', error);\n    }\n  };\n\n  _onActivate = async () => {\n    await this._permissionAccess();\n    await this._requestDeviceAccess();\n    await this._capture();\n\n    this._handleCameraModes(this._cameraModes);\n  };\n\n  _onDeactivate = async () => {\n    if (this._unsubPermissions) {\n      this._unsubPermissions();\n    }\n\n    /** Calling this method here because safari and firefox don't support the inactive event yet */\n    const isChromium = !!window.chrome;\n    if (!isChromium) {\n      this._setPermissionsState('denied');\n    }\n\n    this._stopCapture();\n  };\n\n  /** @param {CameraMode[]} cameraModes */\n  _handleCameraModes = (cameraModes) => {\n    this.$.tabVideoHidden = !cameraModes.includes(CameraSourceTypes.VIDEO);\n    this.$.tabCameraHidden = !cameraModes.includes(CameraSourceTypes.PHOTO);\n\n    const defaultTab = cameraModes[0];\n    if (!this._activeTab || !cameraModes.includes(this._activeTab)) {\n      this._handleActiveTab(defaultTab);\n    }\n  };\n\n  initCallback() {\n    super.initCallback();\n    this.registerActivity(this.activityType, {\n      onActivate: this._onActivate,\n      onDeactivate: this._onDeactivate,\n    });\n\n    this.subConfigValue('cameraMirror', (val) => {\n      this.$.videoTransformCss = val ? 'scaleX(-1)' : null;\n    });\n\n    this.subConfigValue('enableAudioRecording', (val) => {\n      this.$.audioToggleMicrophoneHidden = !val;\n      this.$.audioSelectDisabled = !val;\n    });\n\n    this.subConfigValue('cameraModes', (val) => {\n      if (!this.isActivityActive) return;\n      const cameraModes = deserializeCsv(val);\n      this._handleCameraModes(cameraModes);\n    });\n  }\n\n  _destroy() {\n    for (const permission of DEFAULT_PERMISSIONS) {\n      this[`${permission}Response`]?.removeEventListener('change', this._handlePermissionsChange);\n    }\n\n    navigator.mediaDevices?.removeEventListener('devicechange', this._getDevices);\n  }\n\n  async destroyCallback() {\n    super.destroyCallback();\n\n    this._destroy();\n  }\n}\n\nCameraSource.template = /* HTML */ `\n  <uc-activity-header>\n    <button type=\"button\" class=\"uc-mini-btn\" set=\"onclick: *historyBack\" l10n=\"@title:back\">\n      <uc-icon name=\"back\"></uc-icon>\n    </button>\n    <div set=\"@hidden: !cameraSelectHidden\">\n      <uc-icon name=\"camera\"></uc-icon>\n      <span l10n=\"caption-camera\"></span>\n    </div>\n    <uc-select\n      class=\"uc-camera-select\"\n      set=\"$.options: cameraSelectOptions; @hidden: cameraSelectHidden; onchange: onCameraSelectChange\"\n    >\n    </uc-select>\n    <button\n      type=\"button\"\n      class=\"uc-mini-btn uc-close-btn\"\n      set=\"onclick: *closeModal\"\n      l10n=\"@title:a11y-activity-header-button-close;@aria-label:a11y-activity-header-button-close\"\n    >\n      <uc-icon name=\"close\"></uc-icon>\n    </button>\n  </uc-activity-header>\n  <div class=\"uc-content\">\n    <video\n      muted\n      autoplay\n      playsinline\n      set=\"srcObject: video; style.transform: videoTransformCss; @hidden: videoHidden\"\n      ref=\"video\"\n    ></video>\n    <div class=\"uc-message-box\" set=\"@hidden: messageHidden\">\n      <span l10n=\"l10nMessage\"></span>\n      <button\n        type=\"button\"\n        set=\"onclick: onRequestPermissions; @hidden: requestBtnHidden\"\n        l10n=\"camera-permissions-request\"\n      ></button>\n    </div>\n  </div>\n\n  <div class=\"uc-controls\">\n    <div ref=\"switcher\" class=\"uc-switcher\" set=\"@hidden:!timerHidden\">\n      <button\n        data-id=\"photo\"\n        type=\"button\"\n        class=\"uc-switch uc-mini-btn\"\n        set=\"onclick: onClickTab;  @hidden: tabCameraHidden\"\n      >\n        <uc-icon name=\"camera\"></uc-icon>\n      </button>\n      <button\n        data-id=\"video\"\n        type=\"button\"\n        class=\"uc-switch uc-mini-btn\"\n        set=\"onclick: onClickTab; @hidden: tabVideoHidden\"\n      >\n        <uc-icon name=\"video-camera\"></uc-icon>\n      </button>\n    </div>\n\n    <button class=\"uc-secondary-btn uc-recording-timer\" set=\"@hidden:timerHidden; onclick: onToggleRecording\">\n      <uc-icon set=\"@name: currentTimelineIcon\"></uc-icon>\n      <span ref=\"timer\"> 00:00 </span>\n      <span ref=\"line\" class=\"uc-line\"></span>\n    </button>\n\n    <div class=\"uc-camera-actions uc-camera-action\" set=\"@hidden: cameraActionsHidden\">\n      <button type=\"button\" class=\"uc-secondary-btn\" set=\"onclick: onRetake\">Retake</button>\n      <button type=\"button\" class=\"uc-primary-btn\" set=\"onclick: onAccept\" data-testid=\"accept\">Accept</button>\n    </div>\n\n    <button\n      type=\"button\"\n      class=\"uc-shot-btn uc-camera-action\"\n      data-testid=\"shot\"\n      set=\"onclick: onStartCamera; @class: mutableClassButton; @hidden: cameraHidden;\"\n    >\n      <uc-icon set=\"@name: currentIcon\"></uc-icon>\n    </button>\n\n    <div class=\"uc-select\">\n      <button class=\"uc-mini-btn uc-btn-microphone\" set=\"onclick: onToggleAudio; @hidden: audioToggleMicrophoneHidden;\">\n        <uc-icon set=\"@name:toggleMicrophoneIcon\"></uc-icon>\n      </button>\n\n      <uc-select\n        class=\"uc-audio-select\"\n        set=\"$.options: audioSelectOptions; onchange: onAudioSelectChange; @hidden: audioSelectHidden; @disabled: audioSelectDisabled\"\n      >\n      </uc-select>\n    </div>\n  </div>\n`;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}